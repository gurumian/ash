# FAC1 연결 재시도 로직 분석 및 통합 검토

## FAC1의 연결 재시도 로직

### 핵심 기능
1. **connectWithRetry 함수** (`useConnectionLogic.js`)
   - 설정 기반 재시도: `sshRetryEnabled`, `sshRetryTimeout`, `sshMaxRetries`
   - 재시도 모달 표시: 진행 상황과 시도 횟수 표시
   - 사용자 취소 가능: 재시도 중 취소 버튼 제공
   - 각 시도 사이 대기: `sshRetryTimeout` (기본 1초) 간격

2. **설정값** (기본값)
   - `sshRetryEnabled: true`
   - `sshRetryTimeout: 1000` (1초)
   - `sshMaxRetries: 60` (최대 60회)

3. **재시도 모달** (`ConnectionRetryModal.jsx`)
   - 연결 정보 표시 (Host, User, Port)
   - 진행 바 (시도 횟수/최대 횟수)
   - 경과 시간 표시
   - 취소 버튼

### 재시도 로직 흐름
```
1. connectWithRetry 호출
2. 재시도 모달 표시
3. for 루프로 최대 재시도 횟수만큼 반복:
   - SSH 연결 시도
   - 성공 시: 모달 닫고 연결 반환
   - 실패 시: sshRetryTimeout만큼 대기 후 다음 시도
4. 모든 시도 실패 시: 에러 throw
```

## 현재 프로젝트 (ash-no-agent)의 재연결 로직

### 현재 구현
- **reconnectSSHSession**: 단일 시도만 수행
- 실패 시 즉시 에러 표시
- 재시도 로직 없음

### 재연결 흐름
```
1. 사용자가 Reconnect 버튼 클릭
2. reconnectSSHSession 호출
3. SSH 연결 시도 (1회만)
4. 성공/실패에 따라 결과 표시
```

## 통합 가능성 검토

### ✅ 통합 가능한 부분

1. **재시도 로직 자체**
   - FAC1의 `connectWithRetry` 로직을 `reconnectSSHSession`에 통합 가능
   - 재시도 횟수와 간격을 설정으로 관리 가능

2. **설정 추가**
   - Settings에 재시도 관련 옵션 추가 가능
   - 기본값: 재시도 활성화, 1초 간격, 60회

3. **재시도 상태 표시**
   - 현재 "Reconnecting..." 메시지 대신 더 상세한 정보 표시 가능
   - 터미널에 시도 횟수 표시 가능

### ⚠️ 고려사항

1. **재시도 모달**
   - FAC1은 모달을 사용하지만, ash-no-agent는 터미널 중심 UI
   - 모달 대신 터미널에 상태 표시하는 것이 더 자연스러울 수 있음
   - 또는 간단한 토스트/인디케이터 사용

2. **사용자 취소**
   - 재시도 중 취소 기능 필요 여부
   - 현재는 버튼이 disabled 상태이므로 취소 불가
   - 취소 기능 추가 시 UX 개선 가능

3. **재시도 간격**
   - FAC1: 1초 간격
   - ash-no-agent: 현재 재연결 시도가 즉시 실행됨
   - 재시도 간격을 설정 가능하게 하는 것이 좋음

## 통합 제안

### 옵션 1: 간단한 재시도 (권장)
- 재시도 로직만 추가 (모달 없음)
- 터미널에 시도 횟수 표시: "Reconnecting... (2/60)"
- Settings에 재시도 옵션 추가 (활성화/비활성화, 간격, 최대 횟수)
- 재시도 중 취소 기능은 선택사항

### 옵션 2: 모달 포함 재시도
- FAC1과 동일하게 재시도 모달 추가
- 진행 상황을 모달로 표시
- 취소 기능 제공
- 더 많은 UI 작업 필요

### 옵션 3: 하이브리드
- 기본적으로는 터미널에 상태 표시
- 설정에서 "Show retry modal" 옵션 제공
- 사용자가 선택 가능

## 권장 구현 방향

**옵션 1 (간단한 재시도)**을 권장합니다:

1. **Settings에 재시도 옵션 추가**
   - "Enable reconnect retry" (기본값: true)
   - "Retry interval (ms)" (기본값: 1000)
   - "Max retry attempts" (기본값: 60)

2. **reconnectSSHSession에 재시도 로직 추가**
   - 설정값을 읽어서 재시도 여부 결정
   - 재시도 루프 구현
   - 각 시도 사이 대기

3. **터미널에 상태 표시**
   - "Reconnecting... (2/60)" 형식으로 표시
   - 재시도 중에는 버튼이 회전 애니메이션 유지

4. **에러 처리**
   - 모든 재시도 실패 시 기존 에러 다이얼로그 표시
   - 마지막 에러 메시지 포함

## 구현 시 주의사항

1. **재시도 중 취소**
   - 현재는 버튼이 disabled이므로 취소 불가
   - 취소 기능 추가 시 `retryCancelledRef` 같은 ref 사용 필요

2. **재시도 간격**
   - 너무 짧으면 서버에 부담
   - 너무 길면 사용자 경험 저하
   - 기본값 1초는 적절해 보임

3. **최대 재시도 횟수**
   - 60회는 약 1분 (1초 간격 기준)
   - 사용자가 설정 가능하게 하는 것이 좋음

4. **재시도 중 다른 작업**
   - 재시도 중에도 다른 세션은 정상 작동해야 함
   - 비동기 처리로 블로킹 방지

